name: Build qBittorrent (Windows x64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
    # 1️⃣ 拉取源码
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 2️⃣ 安装 MSYS2 + 依赖
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-qt6
          mingw-w64-x86_64-libtorrent-rasterbar
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-zlib

    # 3️⃣ 修复 MinGW/GCC 下的 NULL 比较问题（关键）
    - name: Patch Windows power inhibitor bug
      run: |
        sed -i 's/!= NULL/!= 0/g' \
          src/gui/powermanagement/inhibitorwindows.cpp

    # 4️⃣ CMake 配置
    - name: Configure
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DGUI=ON \
          -DWEBUI=ON \
          -DCMAKE_CXX_FLAGS="-Wno-error=pointer-arith"

    # 5️⃣ 编译
    - name: Build
      run: |
        cmake --build build --parallel

    # 6️⃣ 打包绿色版
    - name: Bundle runtime (green version)
      run: |
        mkdir -p package/platforms

        # 主程序
        cp build/qbittorrent.exe package/

        # Qt 核心 DLL
        cp /mingw64/bin/Qt6Core.dll package/
        cp /mingw64/bin/Qt6Gui.dll package/
        cp /mingw64/bin/Qt6Widgets.dll package/
        cp /mingw64/bin/Qt6Network.dll package/
        cp /mingw64/bin/Qt6Svg.dll package/

        # Qt 平台插件（必须）
        cp /mingw64/share/qt6/plugins/platforms/qwindows.dll package/platforms/

        # libtorrent / openssl / runtime
        cp /mingw64/bin/libtorrent*.dll package/
        cp /mingw64/bin/libssl*.dll package/
        cp /mingw64/bin/libcrypto*.dll package/
        cp /mingw64/bin/zlib1.dll package/
        cp /mingw64/bin/libstdc++-6.dll package/
        cp /mingw64/bin/libgcc_s_seh-1.dll package/
        cp /mingw64/bin/libwinpthread-1.dll package/

    # 7️⃣ 压缩
    - name: Create zip
      shell: powershell
      run: |
        Compress-Archive package qbittorrent-windows-x64.zip

    # 8️⃣ 上传产物
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: qbittorrent-windows-x64
        path: qbittorrent-windows-x64.zip
